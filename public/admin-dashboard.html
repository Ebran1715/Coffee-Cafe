<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Serados Cafe - Admin Dashboard</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ===== SAME STYLES (UNCHANGED) ===== */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Segoe UI,Tahoma,Verdana,sans-serif;background:#f5f5f5}
.admin-header{background:#fff;padding:20px 40px;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center}
.logo{color:#2e8b57;font-size:24px;font-weight:bold}
.logout-btn{background:#ff4757;color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-weight:bold}
.dashboard-container{max-width:1400px;margin:30px auto;padding:0 20px}
.controls{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.filter-btn{padding:10px 20px;background:#fff;border:1px solid #ddd;border-radius:5px;cursor:pointer}
.filter-btn.active,.filter-btn:hover{background:#2e8b57;color:#fff}
.orders-table{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.05);overflow-x:auto}
.status-badge{padding:5px 10px;border-radius:20px;font-size:12px;font-weight:bold}
.status-received{background:#e3f2fd;color:#1976d2}
.status-preparing{background:#fff3cd;color:#856404}
.status-ready{background:#d4edda;color:#155724}
.status-completed{background:#d1ecf1;color:#0c5460}
.action-btn{padding:5px 10px;border:none;border-radius:3px;cursor:pointer;font-size:12px}
.view-btn{background:#3498db;color:#fff}
.complete-btn{background:#2ecc71;color:#fff}
.loading{text-align:center;padding:40px;color:#666}
</style>
</head>

<body>

<!-- HEADER -->
<div class="admin-header">
  <div class="logo">SERADOS CAFE - ADMIN</div>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="dashboard-container">

<!-- FILTERS -->
<div class="controls">
  <button class="filter-btn active" onclick="filterOrders(event,'all')">All</button>
  <button class="filter-btn" onclick="filterOrders(event,'received')">Received</button>
  <button class="filter-btn" onclick="filterOrders(event,'preparing')">Preparing</button>
  <button class="filter-btn" onclick="filterOrders(event,'ready')">Ready</button>
  <button class="filter-btn" onclick="filterOrders(event,'completed')">Completed</button>
  <button class="filter-btn" onclick="filterOrders(event,'today')">Today</button>
</div>

<!-- ORDERS -->
<div class="orders-table">
  <div id="ordersTable" class="loading">Loading orders...</div>
</div>

</div>

<script>
/* ================= AUTH ================= */
if (sessionStorage.getItem('seradosAdminLoggedIn') !== 'true') {
  window.location.href = '/admin';
}

function logout(){
  sessionStorage.clear();
  window.location.href = '/admin';
}

/* ================= DATA ================= */
let allOrders = [];

/* ================= LOAD ORDERS ================= */
async function loadOrders(){
  try{
    const res = await fetch('/api/orders');
    allOrders = await res.json();
    displayOrders(allOrders);
  }catch(err){
    document.getElementById('ordersTable').innerHTML = 'Failed to load orders';
  }
}

/* ================= DISPLAY ================= */
function displayOrders(orders){
  if(!orders.length){
    document.getElementById('ordersTable').innerHTML = 'No orders found';
    return;
  }

  let html = `
  <table width="100%" cellspacing="0">
  <thead>
    <tr>
      <th>Order ID</th>
      <th>Customer</th>
      <th>Total</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead><tbody>`;

  orders.forEach(o=>{
    html+=`
    <tr>
      <td>${o.order_id}</td>
      <td>${o.customer_name}</td>
      <td>â‚¹ ${o.total_amount}</td>
      <td><span class="status-badge status-${o.status}">${o.status}</span></td>
      <td>
        ${o.status!=='completed'
          ? `<button class="action-btn complete-btn" onclick="updateOrderStatus('${o.order_id}','completed')">Complete</button>`
          : ''}
      </td>
    </tr>`;
  });

  html+=`</tbody></table>`;
  document.getElementById('ordersTable').innerHTML = html;
}

/* ================= FILTER (FIXED) ================= */
function filterOrders(event, type){
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  event.target.classList.add('active');

  let result = allOrders;
  const today = new Date().toDateString();

  if(type==='today'){
    result = allOrders.filter(o=>new Date(o.order_date).toDateString()===today);
  }else if(type!=='all'){
    result = allOrders.filter(o=>o.status===type);
  }

  displayOrders(result);
}

/* ================= UPDATE STATUS ================= */
async function updateOrderStatus(orderId,status){
  try{
    const res = await fetch(`/api/orders/${orderId}/status`,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({status})
    });

    const data = await res.json();

    if(data.success){
      alert('Order status updated!');
      loadOrders();
    }else{
      alert('Update failed');
    }
  }catch(err){
    alert('Server error');
  }
}

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded', loadOrders);
</script>

</body>
</html>
